{% extends "cases/base.html" %}
{% load bootstrap %}

{% block content %}
    <table class="table">
        <thead>
            <tr>
                <th>File Name</th>
                <th>Size</th>
                <th>Delete?</th>
            </tr>
        </thead>
        <tbody>
            {% for inc_file in files %}
                <tr>
                    <td><a href="{{ inc_file.file.url }}">{{ inc_file.display_name }}</a></td>
                    <td>{{ inc_file.smart_size }}</td>
                    <td>
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox" value=""
                                   id="delete_checkbox_{{ inc_file.id }}"
                                   data-inc-file-id="{{ inc_file.id }}"
                            onchange="checkBoxChanged(this)">
                        </div>
                    </td>
                </tr>

            {% endfor %}
            <tr>
                <td></td>
                <td></td>
                <td>
                    <button class="btn btn-primary"
                            id="deleteButton">
                        Delete Files
                    </button>
                </td>
            </tr>
        </tbody>
    </table>
    <script type="text/javascript">
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
            }
            return cookieValue;
        }

        var csrftoken = getCookie('csrftoken');

        function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
            }
        });

        function checkBoxChanged(element) {
            console.log("value changed!");
            console.log(element);
            console.log(element.checked)

        }

        $("#deleteButton").click(function (element) {
            console.log("Delete button clicked");
            console.log(element);
            var all_checks = $(".form-check-input");
            var toDelete = [];
            all_checks.each(function(index){
                if (this.checked) {
                    console.log("Adding this check box to the array");
                    toDelete.push($(this).data("inc-file-id"));
                }
            });
            console.log(toDelete);
            var confirmed = confirm("Are you sure you want to delete these files?");
            if (confirmed) {
                console.log("User confirmed that they want to delete the files.");
                $.ajax({
                    url: "{% url 'delete-files'  incident.id %}",
                    method: "post",
                    data: JSON.stringify(toDelete),
                    dataType: "json",
                    success: function (data) {
                        console.log(data);
                    }
                });
            }

        });

    </script>
{% endblock %}